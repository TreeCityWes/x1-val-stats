name: Update Validator Data

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - main
    paths:
      - 'fetch_validators.py'
      - '.github/workflows/update-validators.yml'

jobs:
  update-validators:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Solana CLI
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.18.4/install)"
        echo "/home/runner/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
    
    - name: Configure Solana CLI
      run: |
        solana config set --url https://rpc.testnet.x1.xyz
    
    - name: Create cache directory
      run: |
        mkdir -p .validator_cache
    
    - name: Cache validator data
      uses: actions/cache@v3
      with:
        path: .validator_cache
        key: ${{ runner.os }}-validator-cache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-validator-cache-
    
    - name: Run validator fetch script
      id: fetch_validators
      run: |
        python fetch_validators.py --fast
      env:
        GITHUB_OUTPUT: ${{ github.output_path }}
        RPC_URL: "https://rpc.testnet.x1.xyz"
        MAX_WORKERS: "5"
        MAX_RETRIES: "3"
        ALWAYS_EXIT_ZERO: "true"
    
    - name: Commit and push if changed
      if: steps.fetch_validators.outputs.validators_changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        # Set the target repository
        git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/TreeCityWes/x1-val-stats.git
        # Create the output directory if it doesn't exist
        mkdir -p public/data
        git add public/data/validators.json
        git commit -m "Update validator data [skip ci]"
        git push -u origin main
